{ config, pkgs, lib, ... }:

let
  # Script to read memory pressure from PSI
  memPressureScript = pkgs.writeShellScript "memory-pressure" ''
    #!/bin/sh
    PATH=${pkgs.gawk}/bin:${pkgs.bc}/bin:${pkgs.coreutils}/bin

    # Read PSI memory pressure (avg60 = 60 second average)
    if [ -f /proc/pressure/memory ]; then
      # Extract the avg60 value from the "some" line
      pressure=$(awk '/^some/ {gsub(/avg60=/, "", $3); print $3}' /proc/pressure/memory)

      # Round to 1 decimal place
      pressure=$(printf "%.1f" "$pressure")

      # Color based on pressure level
      if (( $(echo "$pressure >= 40" | ${pkgs.bc}/bin/bc -l) )); then
        class="critical"
        icon="󰀪"  # High pressure
      elif (( $(echo "$pressure >= 20" | ${pkgs.bc}/bin/bc -l) )); then
        class="warning"
        icon="󰀦"  # Medium pressure
      else
        class="normal"
        icon="󰀦"  # Low pressure
      fi

      # Output in waybar custom module format
      echo "{\"text\": \"$icon $pressure%\", \"class\": \"$class\", \"percentage\": $pressure}"
    else
      echo "{\"text\": \"N/A\", \"class\": \"disabled\"}"
    fi
  '';
in
{
  programs.waybar = {
    enable = true;
    systemd = {
      enable = true;
      target = "river-session.target";
    };
    settings = [{
      height = 30;
      layer = "top";
      position = "bottom";
      tray = { spacing = 10; };
      #modules-center = [ "sway/window" "river/window" ];
      #modules-left = [ "sway/workspaces" "sway/mode" "wlr/workspaces" ];
      modules-center = [ "river/window" ];
      modules-left = [ "river/tags" ];
      modules-right = [
        "custom/memory-pressure"
        "battery"
        "cpu"
        "disk"
        "memory"
        "network"
        "temperature"
        "pulseaudio"
        "tray"
        "clock"
      ];

      battery = {
        format = "{capacity}% {icon}";
        format-alt = "{time} {icon}";
        format-charging = "{capacity}% ";
        format-icons = [ "" "" "" "" "" ];
        format-plugged = "{capacity}% ";
        states = {
          critical = 15;
          warning = 30;
        };
      };

      "river/tags" = {
        num-tags = 6;
        tag-labels = [ "1www" "2dev" "3comms" "4mail" "5" "6" ];
      };

      "custom/memory-pressure" = {
        exec = "${memPressureScript}";
        return-type = "json";
        interval = 5;
        tooltip = true;
        tooltip-format = "Memory Pressure (60s avg): {}%";
      };

      cpu = {
        format = "  {usage}%";
        tooltip = true;
        states = {
          warning = 70;
          critical = 90;
        };
      };

      disk = {
        format = "󰋊 {percentage_used}%";
        path = "/";
        tooltip-format = "Used: {used} / {total}";
        states = {
          warning = 70;
          critical = 90;
        };
      };

      memory = {
        format = "󰍛 {percentage}%";
        tooltip-format = "RAM: {used}GiB / {total}GiB";
        states = {
          warning = 70;
          critical = 90;
        };
      };

      network = {
        format-wifi = "  {essid}";
        format-ethernet = " {ipaddr}";
        format-disconnected = "󰤭 Disconnected";
        tooltip-format = "{ifname}: {ipaddr}/{cidr}";
        tooltip-format-wifi = "{essid} ({signalStrength}%)\n {bandwidthDownBits}  {bandwidthUpBits}";
      };

      temperature = {
        critical-threshold = 80;
        format = "{icon} {temperatureC}°C";
        format-icons = [ "" "" "" "" "" ];
        tooltip = true;
      };

      pulseaudio = {
        format = "{icon} {volume}%";
        format-muted = " {volume}%";
        format-icons = {
          default = [ "" "" "" ];
        };
        on-click = "pavucontrol";
      };

      clock = {
        format = " {:%H:%M}";
        format-alt = " {:%Y-%m-%d}";
        tooltip-format = "<tt><small>{calendar}</small></tt>";
        calendar = {
          mode = "year";
          mode-mon-col = 3;
          weeks-pos = "right";
          on-scroll = 1;
          format = {
            months = "<span color='#ffead3'><b>{}</b></span>";
            days = "<span color='#ecc6d9'><b>{}</b></span>";
            weeks = "<span color='#99ffdd'><b>W{}</b></span>";
            weekdays = "<span color='#ffcc66'><b>{}</b></span>";
            today = "<span color='#ff6699'><b><u>{}</u></b></span>";
          };
        };
      };
    }];

    style = ''
      #tags button.focused {
        color: #d65d0e;
      }
      #tags button.urgent {
        color: #fb4934;
      }

      /* Memory Pressure - Color coded by pressure level */
      #custom-memory-pressure {
        padding: 0 10px;
      }
      #custom-memory-pressure.normal {
        color: #b8bb26;
      }
      #custom-memory-pressure.warning {
        color: #fabd2f;
      }
      #custom-memory-pressure.critical {
        color: #fb4934;
        font-weight: bold;
      }

      /* CPU - Color coded by usage */
      #cpu {
        padding: 0 10px;
        font-family: "NotoSansM Nerd Font", monospace;
      }
      #cpu.warning {
        color: #fabd2f;
      }
      #cpu.critical {
        color: #fb4934;
      }

      /* Disk - Color coded by usage */
      #disk {
        padding: 0 10px;
        font-family: "NotoSansM Nerd Font", monospace;
      }
      #disk.warning {
        color: #fabd2f;
      }
      #disk.critical {
        color: #fb4934;
      }

      /* Memory - Color coded by usage */
      #memory {
        padding: 0 10px;
        font-family: "NotoSansM Nerd Font", monospace;
      }
      #memory.warning {
        color: #fabd2f;
      }
      #memory.critical {
        color: #fb4934;
      }

      /* Temperature - Color coded by heat */
      #temperature {
        padding: 0 10px;
        font-family: "NotoSansM Nerd Font", monospace;
      }
      #temperature.critical {
        color: #fb4934;
        font-weight: bold;
      }

      /* Network */
      #network {
        font-family: "NotoSansM Nerd Font", monospace;
      }

      /* Clock */
      #clock {
        font-family: "NotoSansM Nerd Font", monospace;
      }

      /* Audio */
      #pulseaudio {
        font-family: "NotoSansM Nerd Font", monospace;
      }

      /* Battery */
      #battery {
        font-family: "NotoSansM Nerd Font", monospace;
      }
    '';
  };
}
